<html>
   <head>
      <meta http-equiv="Content-Type" content="text/html; charset=ISO-8859-1">
   
      <title>Chapter&nbsp;10.&nbsp;Amazon EC2 Integration</title>
      <link rel="stylesheet" href="main.css" type="text/css">
      <meta name="generator" content="DocBook XSL Stylesheets V2009-08-07">
      <link rel="home" href="index.html" title="ProActive Scheduling Documentation">
      <link rel="up" href="ResourceManager.html" title="Part&nbsp;II.&nbsp;ProActive Resource Manager">
      <link rel="prev" href="Resource_Manager_plugin.html" title="Chapter&nbsp;9.&nbsp;Resource Manager's Eclipse Plugin">
      <link rel="next" href="RM_API.html" title="Chapter&nbsp;11.&nbsp;Use Resource Manager with Java API">
      <link rel="copyright" href="LegalNotice.html" title="Legal Notice">
   </head>
   <body bgcolor="white" text="black" link="#0000FF" vlink="#840084" alink="#0000FF">

      <div class="chapter" lang="en">
         <div class="titlepage">
            <div>
               <div>
                  <h2 class="title"><a name="RM_EC2"></a>Chapter&nbsp;10.&nbsp;Amazon EC2 Integration
                  </h2>
               </div>
            </div>
         </div>
           
         
           
         <div class="section" lang="en">
            <div class="titlepage">
               <div>
                  <div>
                     <h2 class="title" style="clear: both"><a name="EC2_AMI"></a>.&nbsp;AMI Creation
                     </h2>
                  </div>
               </div>
            </div>
                
            <p>
                     If the default public image doesn't fit your needs, you can bundle your own AMI.
                     The advantages of doing so is that you can:
                     
            </p>
            <div class="itemizedlist">
               <ul type="disc">
                  <li>
                     <p>
                        	    Use a specific initial image for licencing, performance or architecture concerns.
                        	
                     </p>
                  </li>
                  <li>
                     <p>
                        	    Install custom versions of ProActive Scheduling, for compatibility concerns,
                        	    because you want to use your own modified version, or maybe to try a pre-release.
                        	
                     </p>
                  </li>
                  <li>
                     <p>
                        	    Install a specific JDK, for performances, compatibility or licencing concerns.
                        	
                     </p>
                  </li>
                  <li>
                     <p>
                        	    Customize the image by installing arbitrary software or services,
                        	    or tuning it to your needs.
                        	
                     </p>
                  </li>
               </ul>
            </div>
            <p>
                   
            </p>
                
            <p>
                     The procedure is more complex than just using an existing image, but some of the steps has been automated for Unix AMI
               creation.
                     Windows AMI creation, however, cannot be automated.
                   
            </p>
            
                
            <div class="section" lang="en">
               <div class="titlepage">
                  <div>
                     <div>
                        <h3 class="title"><a name="EC2_AMI_Unix"></a>.1.&nbsp;Unix
                        </h3>
                     </div>
                  </div>
               </div>
                     
               <div class="orderedlist"><a name="EC2_AMI_Unix_env"></a><p class="title"><b>Setting the environment for AMI creation</b></p>
                  <ol type="1">
                     <li>
                        <p>
                           	    To create an AMI, you need an S3 account. This Amazon Service allows you to store online data,
                           	    this is where AMI are uploaded and made available to users.
                           	    Sign up for Amazon S3 at
                           	    <a class="link" href="http://aws.amazon.com/s3/" target="_top">http://aws.amazon.com/s3/</a>.
                           	
                        </p>
                     </li>
                     <li>
                        <p>
                           	    On the AWS website, find the menu called <span class="emphasis"><em>Your Web Services Account</em></span>,
                           	    and select <span class="emphasis"><em>AWS Access Identifiers</em></span>.
                           	    You are now going to generate an <span class="emphasis"><em>X.509</em></span> certificate, which consists
                           	    in a public (cert-xxx.pem) and private key (pk-xxx.pem).
                           	    Download those keys on you local drive, and be sure to set the right permissions
                           	    (chmod 600).
                           	
                        </p>
                     </li>
                     <li>
                        <p>
                           	    You need to get the command line tools to interact with EC2,
                           	    which consist in two packages:
                           	    <a class="link" href="http://developer.amazonwebservices.com/connect/entry.jspa?externalID=368&amp;categoryID=88" target="_top">
                              	      the EC2 AMI tools</a> and
                           	    <a class="link" href="http://developer.amazonwebservices.com/connect/entry.jspa?externalID=351&amp;categoryID=88" target="_top">
                              	      the EC2 API tools</a>.
                           	    The scripts for both tools need to be located in the same directory, ie. the content of ~/api-tools/bin and ~/ami-tools/bin
                           need to end up in
                           	    the same ~/ec2-tools/bin, so that the $EC2_HOME environment variable, which all those scripts use, is set to ~/ec2-tools/.
                           	
                        </p>
                     </li>
                     <li>
                        <p>
                           	    Now you need to setup your shell environment (for example in your ~/.bashrc) so that the EC2 command line tools
                           	    can work properly:
                           	    
                        </p><pre class="screen">
export EC2_HOME=/path/to/api/and/ami/ec2-tools/
export EC2_PRIVATE_KEY=/home/foo/.ec2/pk-xxx.pem
export EC2_CERT=/home/foo/.ec2/cert-xxx.pem
export PATH=$PATH:$EC2_HOME/bin
</pre><p>
                           	
                        </p>
                     </li>
                     <li>
                        <p>
                           	    You can now generate an RSA key, that will allow direct SSH connections to instances you create.
                           	    
                        </p><pre class="screen">
ec2-add-keypair foo-ec2-keypair &gt; /home/foo/.ec2/id_rsa-foo-ec2-keypair
chmod 600 /home/foo/.ec2/id_rsa-foo-ec2-keypair
</pre><p>
                           	    Your key is now registered on EC2 as <span class="emphasis"><em>foo-ec2-keypair</em></span>.
                           
                           	    Add the following to your environment:
                           	    
                        </p><pre class="screen">
export EC2_KEYPAIR=foo-ec2-keypair
export EC2_SSH=/home/foo/.ec2/id_rsa-foo-ec2-keypair
</pre><p>
                           	
                        </p>
                     </li>
                     <li>
                        <p>
                           	    Now, you need to create you own Bucket. A Bucket is basically a folder on Amazon S3,
                           	    where you are going to put your new AMI.
                           	    You need to get the S3 command tools and follow the instructions at
                           	    <a class="link" href="http://aws.amazon.com/s3/" target="_top">http://s3tools.org/s3cmd/</a>.
                           	    Once your bucket is created, add the following to your environment:
                           	    
                        </p><pre class="screen">
export BUCKET="bucket-name"
</pre><p>
                           	
                        </p>
                     </li>
                     <li>
                        <p>
                           	    Add to your environment values for <span class="emphasis"><em>AWS_AKEY</em></span>,
                           	    <span class="emphasis"><em>AWS_SKEY</em></span> and <span class="emphasis"><em>EC2_USER</em></span>, which you already put
                           	    in the file <span class="emphasis"><em>/config/deployment/ec2.properties</em></span> as described in
				    the Scheduling user documentation.
                           	
                        </p>
                     </li>
                  </ol>
               </div>
               
                     
               <p>
                  	Now that your environment is set, you can run the AMI creation script, which is located in
                  	<span class="emphasis"><em>/dev/release/ec2/createAMI.sh</em></span>. Its purpose is to create an AMI that will
                  	embed Scheduler, launch a ProActive runtime at boot and register it to
                  	a remote Resource Manager given dynamic parameters.
                  	To achieve this, the scripts creates a new EC2 instance, sends archives containing the required
                  	components on it, install them, and bundles a new image given the current state of the instance.
                        
               </p>
                     
               <p>
                  	Here is a list of noteworthy options for <span class="emphasis"><em>createAMI.sh</em></span>:
                  	
               </p>
               <div class="itemizedlist">
                  <ul type="disc">
                     <li>
                        <p>
                           	      <span class="emphasis"><em>-a AMI</em></span>, specify a custom initial AMI instead of the default Fedora 8.
                           	      To create an AMI, this script boots a new instance with an initial AMI, installs all components
                           	      on it, and then makes a snapshot of the modified instance to upload a new AMI.
                           	      Using different initial images lead to different AMI: this scripts works fine with the default Fedora,
                           	      and has been successfully tested with a Debian initial AMI. If the AMI specified with
                           	      the -a switch is too different from the tested ones, the script may fail. Possible reasons include:
                           	      
                        </p>
                        <div class="itemizedlist">
                           <ul type="circle">
                              <li>
                                 <p>
                                    		    To start a ProActive runtime at boot, createAMI.sh adds a startup script in /etc/rc.local.
                                    		    If the AMI used does not run this file at startup, the node won't be up. You need to adapt
                                    		    <span class="emphasis"><em>/dev/release/ec2/data/installAMI.sh</em></span> by replacing the references to /etc/rc.local
                                    		    to whatever script is run last at boot.
                                    		
                                 </p>
                              </li>
                              <li>
                                 <p>
                                    		    The <span class="emphasis"><em>/dev/release/ec2/data/installAMI.sh</em></span> script assumes some standart
                                    		    GNU tools are installed on the system.
                                    		    You may get a 'X: command not found' error if one of those tools is not present.
                                    		    Solution to this problem is to find an equivalent and adapt the script,
                                    		    or make the script install the right tool before it is needed.
                                    		
                                 </p>
                              </li>
                           </ul>
                        </div>
                        <p>
                           	  
                        </p>
                     </li>
                     <li>
                        <p>
                           	      <span class="emphasis"><em>-w</em></span>, make the install script wait for user input after all components
                           	      are installed on the instance, and just before bundling and uploading the new AMI.
                           	      This allows the user to run custom commands on the instance through SSH, customizing
                           	      the image just before its creation.
                           	  
                        </p>
                     </li>
                     <li>
                        <p>
                           	      <span class="emphasis"><em>-p SCHEDULING, -j JAVA</em></span>, select alternative location for ProActive Scheduling
                           	      and Java. To create the new AMI, this script will install archives containing ProActive Scheduling
                           	      and Java. Default values are the JDK located at $JAVA_HOME if set, and the Scheduling version this
                           	      script is located in. Alternatively, you can specify a .tar, .tar.gz, .tar.bz2 or .zip archive
                           	      for -p and -j: this makes the script faster, as it doesn't need to create the archives itself,
                           	      and also allows to use different versions, which can be useful for Scheduling as the Resource Manager
                           	      and the instance's versions need to match. Note that you can also specify archives located
                           	      on a remote HTTP, HTTPS or FTP server, ie. using <span class="emphasis"><em>-p http://example.org/my-repo/PA.zip</em></span>.
                           	  
                        </p>
                     </li>
                     <li>
                        <p>
                           	      <span class="emphasis"><em>-x</em></span>, bundle the AMI as x86_64 arch instead of default i386.
                           	      Use this when specifying an x86_64 initial AMI with the -a option.
                           	      As only Extra Large instances can run x86_64 AMIs, using this option
                           	      will cause the script to cost more than using the regular i386 bundling.
                           	  
                        </p>
                     </li>
                     <li>
                        <p>
                           	      <span class="emphasis"><em>-n</em></span>, do not install the autorun scripts on the bundled instance.
                           	      Use this switch if you do not want that a ProActive Scheduler node registers to a remote
                           	      Resource Manager at boot, or if you are bundling a ProActive Programming image
                           	      for another use case.
                           	  
                        </p>
                     </li>
                     <li>
                        <p>
                           	      <span class="emphasis"><em>-h</em></span>, print all available options.
                           	  
                        </p>
                     </li>
                  </ul>
               </div>
               <p>
                        
               </p>
                     
               <div class="section" lang="en">
                  <div class="titlepage">
                     <div>
                        <div>
                           <h4 class="title"><a name="EC2_AMI_Example"></a>.1.1.&nbsp;Examples
                           </h4>
                        </div>
                     </div>
                  </div>
                  	
                  <p>
                     	  
                  </p><pre class="screen">
/home/bob/PA/dev/release/ec2 $ ./createAMI.sh
</pre><p>
                     	  The most basic example possible: no mandatory argument. The script will run in interactive mode,
                     	  asking the user to interact with it if needed, and bundle the instance with the ProActive Scheduling version
                     	  this script is located in.
                     	  
                  </p><pre class="screen">
/home/bob/PA/dev/release/ec2 $ ./createAMI.sh -i -o -p /tmp/Scheduling.tar.gz -j http://java.sun.com/jdk16.zip -c -a ami-xxxxxxxx
      </pre><p>
                     	  In this more elaborate example, the script will:
                     	  
                  </p>
                  <div class="itemizedlist">
                     <ul type="disc">
                        <li>
                           <p>
                              		Run in non-interactive mode with the <span class="emphasis"><em>-i</em></span> switch;
                              		meaning no user input will be required, which is useful for automation.
                              	    
                           </p>
                        </li>
                        <li>
                           <p>
                              		Overwrite existing files with the <span class="emphasis"><em>-o</em></span> switch;
                              		if the script detects that a ProActive Scheduling archive has already been created at the default
                              		location, it will overwrite it and not use it.
                              	    
                           </p>
                        </li>
                        <li>
                           <p>
                              		Use an alternative ProActive Scheduling archive with <span class="emphasis"><em>-p /tmp/Scheduling.tar.gz</em></span>,
                              		instead of creating a new one.
                              	    
                           </p>
                        </li>
                        <li>
                           <p>
                              		Use an alternative JDK archive located on a remote HTTP server with
                              		<span class="emphasis"><em>-j http://java.sun.com/jdk16.zip</em></span>; making the script much faster:
                              		this archive will only be downloaded on the remote instance, no need to upload it
                              		ourselves.
                              	    
                           </p>
                        </li>
                        <li>
                           <p>
                              		By default, the script checks the validity of remote archives when passed using the
                              		-j or -p option; using the <span class="emphasis"><em>-c</em></span> switch overrides this behaviour:
                              		useful when the machine on which the script is executed is firewalled and cannot connect
                              		to the outside using the required port.
                              	    
                           </p>
                        </li>
                        <li>
                           <p>
                              		Specify an alternative initial AMI to create the instance with the <span class="emphasis"><em>-a ami-xxxxxxxx</em></span>
                              		option.
                              	    
                           </p>
                        </li>
                     </ul>
                  </div>
                  <p>
                     	
                  </p>
                        
               </div>
                   
            </div>
                
            <div class="section" lang="en">
               <div class="titlepage">
                  <div>
                     <div>
                        <h3 class="title"><a name="EC2_AMI_Windows"></a>.2.&nbsp;Windows
                        </h3>
                     </div>
                  </div>
               </div>
                     
               <p>
                  	Windows AMI creation is more tricky than its Unix counterpart: indeed,
                  	Windows Server 2003, which is the default Windows AMI provided by Amazon,
                  	doesn't expose any remote service similar to SSH that could allow the remote
                  	execution of scripts, or even the installation of basic components like an SSH server.
                        
               </p>
                     
               <p>
                  	To create a Windows AMI, users need to log in using the Remote Desktop server
                  	on the instance, and execute all steps manually.
                        
               </p>
                     
               <div class="orderedlist">
                  <ol type="1">
                     <li>
                        <p>
                           	    Follow all steps in <a href="#EC2_AMI_Unix_env" title="Setting the environment for AMI creation">Setting the environment for AMI creation</a>, bundling a Windows AMI requires the same tools
                           	    and configuration as creating an Unix one. Note that <a href="#EC2_AMI_Unix_env" title="Setting the environment for AMI creation">Setting the environment for AMI creation</a> describes how 
                           	    to setup the tools in an Unix environment, you will need to adapt if attempting to bundle from 
                           	    a Windows system.
                           	
                        </p>
                     </li>
                     <li>
                        <p>
                           	    Start a new Windows AMI. During this guide, we will use <span class="emphasis"><em>ec2-public-windows-images/Server2003r2-i386-Win-v1.06.manifest.xml</em></span>: 
                           	    
                        </p><pre class="screen">
$ ec2-describe-images -o amazon
IMAGE   ami-de4daab7    ec2-public-windows-images/Server2003r2-i386-Win-v1.06.manifest.xml      amazon  available       public          i386    machine                 windows
$ ec2-run-instances ami-de4daab7 -k foo-ec2-keypair
</pre><p>
                           	
                        </p>
                     </li>
                     <li>
                        <p>
                           	    Once the instance is up and running, log in using rdesktop, or whatever Remote Desktop client you happen to have at your
                           disposal.
                           	    The login is <span class="emphasis"><em>Administrator</em></span>, and you can get the password using the <span class="emphasis"><em>ec2-get-password</em></span> command 
                           	    (which requires the RSA private key file corresponding to the keypair used in ec2-run-instance as -k option).
                           	    
                        </p><pre class="screen">
$ ec2-describe-instances
INSTANCE i-xxxxxxxx ami-de4daab7 ec2-xxx-xxx-xxx-xxx.compute-1.amazonaws.com ip-xxx-xxx-xxx-xxx.ec2.internal  running foo-ec2-keypair 0 m1.small 2009-07-28T08:24:12+0000 us-east-1d windows
$ ec2-get-password i-xxxxxxxx -k /home/foo/.ec2/id_rsa-foo-ec2-keypair
password
$ rdesktop -u Administrator -p password ec2-xxx-xxx-xxx-xxx.compute-1.amazonaws.com
</pre><p>
                           	    Note that you may need to be patient at this point: booting a Windows AMI is for some reason much slower than a Linux
                           AMI,
                           	    and Remote Desktop Server or Password information are not immediately available even
                           	    when the instance shows as 'running'. If a query fails, persist.
                           	
                        </p>
                     </li>
                     <li>
                        <p>
                           	    Now that your are logged on your Windows EC2 Instance,
                           	    open Internet Explorer, download and install the latest JRE from Sun's website.
                           	    To complete the install, you can optionnaly set the JAVA_HOME variable; open a command prompt:
                           	    
                        </p><pre class="screen">
&gt; setx JAVA_HOME "C:\Program Files\path\to\the\jre"
</pre><p>
                           	    Note that you may need to restart the Command prompt for the setx command to take effect.
                           	
                        </p>
                     </li>
                     <li>
                        <p>
                           	    Now, you need to get the ProActive Scheduling version you want to bundle in your image.
                           	    The simplest way is to put a zipped archive of the whole tree on a remote HTTP server,
                           	    so you can download it with Internet Explorer.
                           	    Note that the only mandatory files are located in <span class="emphasis"><em>{PA_SCHEDULER}\dist</em></span>, all other directories
                           	    can be skipped if not needed for debugging purpose.
                           	    From now on, we will assume that the ProActive root directory is <span class="emphasis"><em>C:\ProActive</em></span>
                           	    (ie. you should have a C:\ProActive\dist\lib\ProActive.jar).
                           	
                        </p>
                     </li>
                     <li>
                        <p>
                           	    Now is the tricky part: to start a ProActive runtime at boot, we need to register
                           	    a Java program, or a Batch script running a Java program, as a Windows Service.
                           	    Because of Java, however, this is not a task you can achieve trivially on Windows.
                           	    We are going to need a Java Service Wrapper that will launch our Java program the right
                           	    way so that it can be started as an NT Service.
                           	    Several projects exist, we will use <span class="emphasis"><em>Java Service Wrapper</em></span> in this guide.
                           	    Go to <a class="link" href="http://wrapper.tanukisoftware.org/doc/english/download.jsp" target="_top">the download page</a>
                           	    and get the free (GPLv2) Community version for Windows.
                           	    You will need to do some manual configuration at this point:
                           	    
                        </p>
                        <div class="orderedlist">
                           <ol type="a">
                              <li>
                                 <p>
                                    		  From the Wrapper root directory, go to <span class="emphasis"><em>{WRAPPER}\src\bin</em></span>
                                    	      
                                 </p>
                              </li>
                              <li>
                                 <p>
                                    		  Copy App.bat.in, InstallApp-NT.bat.in, UninstallApp-NT.bat.in,
                                    		  move them to <span class="emphasis"><em>{WRAPPER}\bin\</em></span>, and rename the extension from <span class="emphasis"><em>.bat.in</em></span> to <span class="emphasis"><em>.bat</em></span>.
                                    		  Those files will not need to be edited, they are respectively used to: run your application for testing purpose, install
                                    the service, uninstall it.
                                    	      
                                 </p>
                              </li>
                              <li>
                                 <p>
                                    		  Copy <span class="emphasis"><em>{WRAPPER}\src\conf\wrapper.conf.in</em></span> to <span class="emphasis"><em>{WRAPPER}\conf\wrapper.conf</em></span>,
                                    		  this config file will be used when running the three batch scripts you previously installed.
                                    	      
                                 </p>
                              </li>
                              <li>
                                 <p>
                                    		  Now you need to edit the config. Assuming the locations are correct, here are the most noteworthy properties you need
                                    to change or add:
                                    		  
                                 </p><pre class="screen">
# mandatory classpath entries, ProActive won't run without these jars
wrapper.java.classpath.1=../lib/wrapper.jar
wrapper.java.classpath.3=C:\ProActive\dist\lib\jruby.jar
wrapper.java.classpath.4=C:\ProActive\dist\lib\jython-2.5.4-rc1.jar
wrapper.java.classpath.4=C:\ProActive\dist\lib\groovy-all-2.1.5.jar
wrapper.java.classpath.5=C:\ProActive\dist\lib\commons-logging-1.0.4.jar
wrapper.java.classpath.6=C:\ProActive\dist\lib\ProActive.jar
wrapper.java.classpath.7=C:\ProActive\dist\lib\ProActive_SRM-common.jar
wrapper.java.classpath.8=C:\ProActive\dist\lib\ProActive_ResourceManager.jar
wrapper.java.classpath.9=C:\ProActive\dist\lib\ProActive_Scheduler-core.jar
wrapper.java.classpath.10=C:\ProActive\dist\lib\ProActive_Scheduler-client.jar
wrapper.java.classpath.11=C:\ProActive\dist\lib\ProActive_Scheduler-worker.jar
wrapper.java.classpath.12=C:\ProActive\dist\lib\commons-httpclient-3.0.1.jar
wrapper.java.classpath.13=C:\ProActive\dist\lib\commons-codec-1.3.jar
wrapper.java.classpath.14=C:\ProActive\dist\lib\commons-logging-1.1.jar

# make sure RMI won't prevent us to start a local node with a permissive policy
wrapper.java.additional.1=-Djava.security.policy=C:\java.policy

# first parameter is the class to run, second is the actual parameter of the class to run
wrapper.app.parameter.1=org.ow2.proactive.resourcemanager.utils.WindowsEC2RMStarter
wrapper.app.parameter.2=C:\ProActive

# Cosmetic configuration
wrapper.ntservice.name=RunNode
wrapper.ntservice.displayname=RunNode
wrapper.ntservice.description="Runs a ProActive runtime that registers on a remote Resource Manager"
</pre><p>
                                    		  All other properties should be left as default.
                                    		  A sample configuration is located in <span class="emphasis"><em>{PA_SCHEDULER}\samples\ec2\wrapper.conf</em></span>
                                    		  as an example.
                                    	      
                                 </p>
                              </li>
                              <li>
                                 <p>
                                    		  As described in the configuration file, you need to install a <span class="emphasis"><em>java.policy</em></span>, which may contain:
                                    	    
                                 </p><pre class="screen">
grant {
    permission java.security.AllPermission;
};
</pre><p>
                                    	    Using such a permissive configuration however is not recommanded in a production environment.
                                    	      
                                 </p>
                              </li>
                              <li>
                                 <p>
                                    		  Everything should be setup now. Try to run the <span class="emphasis"><em>{WRAPPER}\bin\App.bat</em></span> script to see if it worked.
                                    		  Then, run the <span class="emphasis"><em>{WRAPPER}\bin\InstallApp-NT.bat</em></span> script to install the service. Be careful:
                                    		  you can not edit wrapper.conf is the service is already installed, you need to uninstall it running 
                                    		  <span class="emphasis"><em>{WRAPPER}\bin\UnInstallApp-NT.bat</em></span>, edit the conf and install the service again.
                                    	      
                                 </p>
                              </li>
                              <li>
                                 <p>
                                    		  Run the Service Manager with the command <span class="emphasis"><em>Services.msc</em></span>. Locate you newly created service in the list,
                                    		  and try to start it manually. If it fails, a log should be available in <span class="emphasis"><em>{WRAPPER}\logs\</em></span>,
                                    		  else, your service has been successfully installed.
                                    	      
                                 </p>
                              </li>
                           </ol>
                        </div>
                        <p>
                           	
                        </p>
                     </li>
                     <li>
                        <p>
                           	    At this point, you may want to cleanup your instance a bit:
                           	    all useless files and archives should be removed from the hard drive to 
                           	    minimize the AMI's size.
                           	
                        </p>
                     </li>
                     <li>
                        <p>
                           	    Get back to the shell on which you have your EC2 tools. You are going to bundle the Windows AMI
                           	    by running the following command:
                           	    
                        </p><pre class="screen">
$ ec2-bundle-instance i-xxxxxxxx -b $BUCKET -p myimage -o $AWS_AKEY -w $AWS_SKEY
</pre><p>
                           	    The bundling task is now pending. Switch back to the remote desktop client,
                           	    and shut down the Windows instance, the bundling process should be starting now.
                           	    You can monitor the bundling process with the following command:
                           	    
                        </p><pre class="screen">
$ ec2-describe-bundle-tasks
</pre><p>
                           	    Once it reaches the "complete" state, you can register it for EC2.
                           	    
                        </p><pre class="screen">
$ ec2-register $BUCKET/myimage.manifest.xml
</pre><p>
                           	    Your windows AMI is now ready to use.
                           	
                        </p>
                     </li>
                  </ol>
               </div>
                   
            </div>
                
            <div class="section" lang="en">
               <div class="titlepage">
                  <div>
                     <div>
                        <h3 class="title"><a name="EC2_AMI_Share"></a>.3.&nbsp;Sharing your AMI
                        </h3>
                     </div>
                  </div>
               </div>
                     
               <p>
                  	This section describes the procedure to make your AMI available to other users.
                  	Amazon allows users to bundle <span class="emphasis"><em>public</em></span> images, which can be used freely by other users,
                  	or <span class="emphasis"><em>paid</em></span> images, which generate revenues for the user that bundles it.
                        
               </p>
                     
               <div class="section" lang="en">
                  <div class="titlepage">
                     <div>
                        <div>
                           <h4 class="title"><a name="EC2_AMI_Share_public"></a>.3.1.&nbsp;Public AMI
                           </h4>
                        </div>
                     </div>
                  </div>
                  	
                  <p>
                     	  To make an AMI public, you need to have the EC2 API Tools (as described in <a href="#EC2_AMI_Unix_env" title="Setting the environment for AMI creation">Setting the environment for AMI creation</a>) and run the following command:
                     	  
                  </p><pre class="screen">
$ ec2-modify-image-attribute &lt;ami_id&gt; --launch-permission -a all
</pre><p>
                     	  Note that you can share the AMI with a specific user instead of making it public to all,
                     	  by specifying an user id instead of <span class="emphasis"><em>all</em></span>.
                     	  To revert the permissions, use the <span class="emphasis"><em>-r</em></span> switch instead of <span class="emphasis"><em>-a</em></span>.
                     	
                  </p>
                        
               </div>
                     
               <div class="section" lang="en">
                  <div class="titlepage">
                     <div>
                        <div>
                           <h4 class="title"><a name="EC2_AMI_Share_paid"></a>.3.2.&nbsp;Paid AMI
                           </h4>
                        </div>
                     </div>
                  </div>
                  	
                  <p>
                     	  Creating a paid AMI is a longer process than just making it public,
                     	  indeed, you must register to Amazon's billing services to be able to get paid.
                     	  The process of creating a paid AMI is the following:
                     	  
                  </p>
                  <div class="orderedlist">
                     <ol type="1">
                        <li>
                           <p>
                              		Create a Windows or a Linux AMI as described in <a href="#EC2_AMI" title=".&nbsp;AMI Creation">Section&nbsp;, &#8220;AMI Creation&#8221;</a>.
                              	    
                           </p>
                        </li>
                        <li>
                           <p>
                              		Register it as a product with the Amazon Devpay service.
                              	    
                           </p>
                        </li>
                        <li>
                           <p>
                              		Use the API tools to associate a product code to the AMI.
                              	    
                           </p>
                        </li>
                        <li>
                           <p>
                              		Make the AMI public as described in <a href="#EC2_AMI_Share_public" title=".3.1.&nbsp;Public AMI">Section&nbsp;.3.1, &#8220;Public AMI&#8221;</a>.
                              	    
                           </p>
                        </li>
                        <li>
                           <p>
                              		Make your AMI available for sale and advertise it.
                              	    
                           </p>
                        </li>
                     </ol>
                  </div>
                  <p>
                     	  Users can then use your AMI by purchasing it, and then launch new instances of it.
                     	
                  </p>
                  	
                  <p>
                     	  Extensive documentation of the process can be found in
                     	  <a class="link" href="http://docs.amazonwebservices.com/AWSEC2/latest/DeveloperGuide/index.html?AESDG-chapter-paidamis.html" target="_top">
                        	    the Amazon EC2 official developper guide.
                        	  </a>	  	  
                     	
                  </p>
                  	
                  <div class="warning" style="margin-left: 0.5in; margin-right: 0.5in;">
                     <table border="0" summary="Warning">
                        <tr>
                           <th align="left">Warning</th>
                        </tr>
                        <tr>
                           <td align="left" valign="top">
                              <p>
                                 	    When creating a paid AMI, if you do not pay attention,
                                 	    users that purchase your AMI once may be able to rebundle it,
                                 	    and then use it for free; if you do not want that to happen, you
                                 	    need to prevent root access to the AMI at creation.
                                 	    
                              </p>
                              <div class="itemizedlist">
                                 <ul type="disc">
                                    <li>
                                       <p>  
                                          		  On a linux system, when creating the AMI with the <span class="emphasis"><em>createAMI.sh</em></span> script,
                                          		  use the <span class="emphasis"><em>-w</em></span> switch to be able to run commands just before the bundling process.
                                          		  The simplest way to prevent root access is to disable the SSH daemon; this will however
                                          		  also prevent you from rebundling it, a better solution is to manipulate
                                          		  the ssh configuration to accept only you key.
                                          	      
                                       </p>
                                    </li>
                                    <li>
                                       <p>  
                                          		  On Windows, disabling the Remote Desktop service should be enough:
                                          		  go to the <span class="emphasis"><em>System Properties</em></span> dialog, and uncheck "Allow users to connect
                                          		  remotely on this computer" in the <span class="emphasis"><em>Remote</em></span> tab.
                                          	      
                                       </p>
                                    </li>
                                 </ul>
                              </div>
                              <p>
                                 	
                              </p>
                           </td>
                        </tr>
                     </table>
                  </div>
                        
               </div>
                   
            </div>
              
         </div>
         
         
      </div>
   </body>
</html>
