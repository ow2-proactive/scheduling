<?xml version="1.0" encoding="UTF-8"?>
<project name="ProActive" default="compile" basedir=".">
	<taskdef name="if" classname="ise.antelope.tasks.IfTask"/>

	<import file="common.xml" />
	<import file="doc.xml" />

	<!-- Osgi properties -->
	<property name="manifest.dir" value="${src.extensions.dir}/org/objectweb/proactive/extensions/osgi/Manifest/" />
	<property name="manifest.example.dir" value="${src.examples.dir}/org/objectweb/proactive/examples/osgi/hello/Manifest/" />
	<property name="bundle.dir" value="${base.dir}/dist/bundle" />
	<property name="osgi.res.dir" value="${src.extensions.dir}/org/objectweb/proactive/extensions/osgi/res/"/>
	<property name="manifest.connector.dir" value="${src.extensions.dir}/org/objectweb/proactive/extensions/osgi/connector/Manifest/"/>

	<!-- Performance test properties -->
	<property name="performanceTestClass" value="performanceTests.simple.PerformanceTest"/>

	<!-- emma -->

	<path id="emma.lib" >
		<pathelement location="${base.dir}/compile/lib/emma_ant.jar" />
		<pathelement location="${base.dir}/compile/lib/emma.jar" />
	</path>

	<taskdef resource="emma_ant.properties" classpathref="emma.lib" />



	<!--
		Create a timestamp for this build 
		If ${version} is defined its value is used as string version for this build
		Otherwise the timestamp is used
	-->
	<tstamp>
		<format property="TODAY" pattern="yyyy-MM-dd" />
	</tstamp>

	<if name="version">
		<property name="version_" value="${version}"/>
		<else>
			<property name="version_" value="${TODAY}"/>
		</else>
	</if>


	<!-- ================================================================ -->
	<!--                   define the different classpaths                -->
	<!--  =============================================================== -->

	<path id="test.classpath">
		<pathelement location="${dist.dir}/ProActive/ProActive.jar"/>
		<path refid="project.libs"/>
		<pathelement location="${cl.test.dir}/"/>
	</path>

	<path id="examples.classpath">
		<path refid="project.classpath" />
		<pathelement location="${lib.dir}/examples/clibwrapper_jiio.jar" />
		<pathelement location="${lib.dir}/examples/jai_codec.jar" />
		<pathelement location="${lib.dir}/examples/jai_core.jar" />
		<pathelement location="${lib.dir}/examples/mlibwrapper_jai.jar" />
		<pathelement location="${lib.dir}/examples/jai_imageio.jar" />
	</path>


	<!-- ================================================================ -->
	<!--                          Compile All                             -->
	<!--  =============================================================== -->

	<target name="compile" depends="core, extensions, extra, util, examples" description="build the class files" />


	<!-- ================================================================ -->
	<!--                  Clean up generated files                        -->
	<!--  =============================================================== -->

	<target name="clean" description="Remove all generated files">
		<delete dir="${classes.dir}" />
		<delete dir="${dist.dir}" />
		<delete dir="${docs.dir}" />
		<delete dir="${classlibs.dir}" />
		<delete dir="${test.classes.dir}" />
		<delete file="tests.log" />
		<delete dir="${junit.dir}" />
	</target>


	<target name="check" depends="-init,util">
		<macrodef name="checkDir">
			<attribute name="dir" />
			<attribute name="tmpdir"/>
			<attribute name="prop"/>
			<sequential>
				<delete dir="@{tmpdir}" />
				<copy todir="@{tmpdir}">
					<fileset dir="@{dir}" />
				</copy>

				<format_m srcDir="@{tmpdir}" />

				<java fork="true" resultproperty="@{prop}" classname="diff.DiffJavaDir">
					<classpath refid="project.classpath" />
					<arg value="@{dir}" />
					<arg value="@{tmpdir}" />
				</java>
				<delete dir="@{tmpdir}" />
			</sequential>
		</macrodef>

		<parallel threadsperprocessor="1">
			<checkDir prop="check.proactive"  dir="${src.proactive.dir}"  tmpdir="${classes.dir}/tmp/ProActive"/>
			<checkDir prop="check.extensions" dir="${src.extensions.dir}" tmpdir="${classes.dir}/tmp/Extensions" />
			<checkDir prop="check.extra"      dir="${src.extra.dir}"      tmpdir="${classes.dir}/tmp/Extra" />
			<checkDir prop="check.examples"   dir="${src.examples.dir}"   tmpdir="${classes.dir}/tmp/Examples" />
			<checkDir prop="check.test"       dir="${src.test.dir}"       tmpdir="${classes.dir}/tmp/Tests" />
		</parallel>

		<condition property="check.failed">
			<or>
				<isfailure code="${check.proactive}" />
				<isfailure code="${check.extensions}" />
				<isfailure code="${check.extra}" />
				<isfailure code="${check.examples}" />
				<isfailure code="${check.test}" />
			</or>
		</condition>

		<if name="check.failed" exists="true">
			<fail message="Please use Jalopy (,/build format)" />
		</if>
	</target>

	<!-- ================================================================ -->
	<!--                       Initialisation                             -->
	<!--  =============================================================== -->

	<target name="-init">
		<!-- Create the build directory structure used by compile -->
		<mkdir dir="${classes.dir}" />
		<mkdir dir="${cl.examples.dir}"/>
		<mkdir dir="${cl.extra.dir}"/>
		<mkdir dir="${cl.extensions.dir}"/>
		<mkdir dir="${cl.proactive.dir}"/>
		<mkdir dir="${cl.test.dir}"/>
		<mkdir dir="${cl.utils.dir}"/>

		<echo message="--- Debugging is ${debug} ---" />
	</target>


	<target name="-configurationCopy" depends="-init">
		<copy toDir="${cl.proactive.dir}">
			<fileset dir="${src.proactive.dir}">
				<include name="org/**/*.xml" />
				<include name="org/**/*.fractal" />
				<include name="org/**/*.properties" />
				<include name="org/**/*.xsd" />
				<include name="org/**/*.png" />
				<include name="org/objectweb/proactive/core/component/adl/xml/proactive.dtd" />
			</fileset>
		</copy>
	</target>


	<!-- ================================================================ -->
	<!--                   Compile ProActive Core                         -->
	<!--  =============================================================== -->

	<target name="core" depends="-configurationCopy" description="Compile the ProActive core classes">
		<!-- If it is a release, update ProActive.getVersion() -->
		<if name="version">
			<replaceregexp 
				file="${src.proactive.dir}/${proactive.path}/ProActive.java"		
				match="\$Id.*\$"
				replace="${version}"
				byline="true" />
		</if>

		<javac srcdir="${src.proactive.dir}:${src.utils.dir}" destdir="${cl.proactive.dir}" deprecation="on" source="${source}" debug="${debug}">
			<classpath refid="project.classpath" />
			<include name="**/*.java" />

			<!-- XXX, MicroTimer should be in core or not used by the core-->
		</javac>

		<rmic base="${cl.proactive.dir}" sourcebase="${cl.proactive.dir}" stubversion="1.2">
			<classpath refid="project.classpath" />
			<include name="org/objectweb/proactive/core/body/jini/JiniRemoteBodyImpl.class"/>
			<include name="org/objectweb/proactive/core/body/rmi/RmiRemoteBodyImpl.class"/>
			<include name="org/objectweb/proactive/core/body/rmi/RmiRemoteBodyForwarderImp.class"/>
			<include name="org/objectweb/proactive/core/body/ft/servers/FTServer.class"/>
			<include name="org/objectweb/proactive/core/runtime/rmi/RmiProActiveRuntimeImpl.class"/>
			<include name="org/objectweb/proactive/core/runtime/rmi/RmiProActiveRuntimeForwarderImpl.class"/>
			<include name="org/objectweb/proactive/core/runtime/jini/JiniRuntimeImpl.class"/>
		</rmic>

		<echo message="Java primitive type wrapper stubs generating..." />
		<java classname="org.objectweb.proactive.ext.util.StubGenerator" fork="true">
			<classpath refid="project.classpath" />
			<arg line="-srcDir ${cl.proactive.dir} -pkg org.objectweb.proactive.core.util.wrapper" />
		</java>

		<!-- XXX: MPI should be in Extensions -->

		<if>
			<bool>
				<and>
					<os family="Unix"/>
					<available file="mpicc" filepath="/bin:/usr/bin:/usr/local/bin"/>
					<!-- Bug #3128: Disable MPI anyway -->
					<available file="mpiIsBrokenIDontWantIt" filepath="/bin"/>
				</and>
			</bool>


			<!-- Delete existing header file to avoid conflict -->
			<delete>
				<fileset dir="${src.proactive.dir}/org/objectweb/proactive/mpi/control">
					<include name="org_objectweb_proactive_mpi_control_ProActiveMPIComm.h"/>
					<include name="org_objectweb_proactive_mpi_control_ProActiveMPIComm_MessageRecvHandler.h"/>
				</fileset>
			</delete>

			<!-- Generate header file (based on classpath) -->
			<javah 
				classpath="${cl.proactive.dir}" 
				force="yes" 
				class="org.objectweb.proactive.mpi.control.ProActiveMPIComm" 
				destdir="${src.proactive.dir}/org/objectweb/proactive/mpi/control/" />

			<!-- Generate library -->
			<exec dir="${cl.proactive.dir}" executable="mpicc" os="Linux">
				<arg line=" -I${java.home}/../include -I${java.home}/../include/linux ${src.proactive.dir}/org/objectweb/proactive/mpi/control/ProActiveMPIComm.c -o ${cl.proactive.dir}/${proactive.path}/mpi/control/libProActiveMPIComm.so -shared" />
			</exec>

			<!-- Delete object file generated in classes repository -->
			<delete>
				<fileset dir="${cl.proactive.dir}">
					<include name="ProActiveMPIComm.o"/>
				</fileset>
			</delete>

			<!-- Delete existing header file to avoid conflict -->
			<delete>
				<fileset dir="${src.proactive.dir}/org/objectweb/proactive/mpi/control">
					<include name="org_objectweb_proactive_mpi_control_ProActiveMPIComm.h"/>
					<include name="org_objectweb_proactive_mpi_control_ProActiveMPIComm_MessageRecvHandler.h"/>
				</fileset>
			</delete>

			<!-- execute configure to generate Makefiles -->
			<exec dir="${src.proactive.dir}/${proactive.path}/mpi/control/config" executable="sh" os="Linux">
				<arg line="configure.sh " />
			</exec>

			<else>
				<echo>Wrapping with control is only available for Unix and mpicc must be installed</echo>
			</else>
		</if>
	</target>


	<!-- ================================================================ -->
	<!--                   Compile ProActive Modules                      -->
	<!--  =============================================================== -->

	<target name="extensions" depends="core" description="Compile the ProActive extensions classes" >
		<subant target="-compile" inheritall="yes" failonerror="true">
			<fileset dir="${src.extensions.dir}" includes="**/build.xml"/>
		</subant>
	</target>


	<target name="extra" depends="core" description="Compile the ProActive extensions classes" >
		<subant target="-compile" inheritall="yes" failonerror="true" >
			<fileset dir="${src.extra.dir}" includes="**/build.xml"/>
		</subant>
	</target>


	<target name="p2p_daemon">
		<exec dir="${daemon.dir}/src/common" executable="cc" os="Linux, Darwin, SunOS">
			<arg line="-Wall -g -o proactivep2p -x c proactivep2p.cpp proactivep2p.h" />
		</exec>
		<exec dir="${daemon.dir}/src/common" executable="cc" os="Linux, Darwin, SunOS">
			<arg line="-Wall -g -o p2pctl -x c p2pctl.c proactivep2p.h" />
		</exec>
		<mkdir dir="${daemon.dir}/build" />
		<move file="${daemon.dir}/src/common/proactivep2p" todir="${daemon.dir}/build" />
		<move file="${daemon.dir}/src/common/p2pctl" todir="${daemon.dir}/build" />
	</target>


	<!-- ================================================================ -->
	<!--                      Compile Examples                            -->
	<!--  =============================================================== -->

	<target name="examples" depends="extensions" description="Compile all the examples">
		<!-- XXX, MicroTimer should be in core or not used by examples-->
		<javac srcdir="${src.examples.dir}:${src.utils.dir}" destdir="${cl.examples.dir}" includes="**/*.java" excludes="${proactive.path}/examples/nbody/common/NBody3DFrame.java" deprecation="on" source="${source}" debug="${debug}" encoding="UTF-8">
			<classpath refid="examples.classpath" />
		</javac>

		<copy todir="${cl.examples.dir}/${proactive.path}/examples" includeEmptyDirs="no">
			<fileset dir="${src.examples.dir}/${proactive.path}/examples">
				<exclude name="**/*.java" />
			</fileset>
		</copy>

		<available classname="com.sun.j3d.utils.behaviors.mouse.MouseWheelZoom" property="java3d_present"/>
		<if name="java3d_present">
			<echo message="Info: Java3D installed." />
			<javac srcdir="${src.examples.dir}" destdir="${cl.examples.dir}" includes="${proactive.path}/examples/nbody/common/NBody3DFrame.java" deprecation="on" source="${source}" debug="${debug}">
				<classpath refid="examples.classpath" />
			</javac>
			<else>
				<echo level="warning" message="Info: Java 3D dependencies were not resolved." />
			</else>
		</if>
	</target>

	<macrodef name="junitMacro">
		<attribute name="nodeDescriptor" />
		<element name="jvmargs" optional="yes" />
		<element name="additionalClasspath" optional="yes" />
		<sequential>
			<javac srcdir="${src.test.dir}" destdir="${cl.test.dir}" includes="unitTests/**" deprecation="on" source="${source}" debug="${debug}">
				<classpath refid="project.classpath" />
			</javac>
			<javac srcdir="${src.test.dir}" destdir="${cl.test.dir}" includes="functionalTests/**" deprecation="on" source="${source}" debug="${debug}">
				<classpath refid="test.classpath" />
			</javac>
			<copy toDir="${cl.test.dir}">
				<fileset dir="${src.test.dir}">
					<include name="functionalTests/**/*.xml" />
					<include name="functionalTests/**/*.fractal" />
					<include name="functionalTests/**/*.properties" />
					<include name="functionalTests/**/*.xsd" />
				</fileset>
			</copy>

			<delete dir="${junit.dir}"/>
			<mkdir dir="${junit.dir}"/>

			<junit printsummary="yes" forkmode="perTest" showoutput="yes">
				<jvmarg value="-Dproactive.dir=${base.dir}"/>


				<classpath>
					<additionalClasspath/>
					<path refid="test.classpath"/>
				</classpath>

				<classpath refid="test.classpath"/>
				<jvmarg value="-Djava.security.policy=${base.dir}/compile/proactive.java.policy" />
				<jvmarg value="-Dlog4j.configuration=file:${base.dir}/compile/proactive-log4j" />
				<jvmarg value="-DfunctionalTests.descriptor.defaultnodes.file=@{nodeDescriptor}" />

				<jvmargs/>
			
				<!--
					Remote Debug:
					<jvmarg value="-Xdebug" />
					<jvmarg value="-Xrunjdwp:transport=dt_socket,server=y,suspend=n,address=8000" />
					
					Yourkit (don't forget to set your LD_LIBRARY_PATH):
					<jvmarg value="-agentlib:yjpagent" />
				-->	



				<formatter type="xml"/>
				<batchtest fork="yes" todir="${junit.dir}">
					<fileset dir="${cl.test.dir}">
						<include name="unitTests/**/*.class"/>
						<include name="functionalTests/**/*Test*.class"/>
						<exclude name="functionalTests/security/*/*.class"/>
						<exclude name="**/*$*.class"/>
						<exclude name="functionalTests/*.class"/>
						<exclude name="functionalTests/component/collectiveitf/multicast/**/*.fractal"/>
						<exclude name="functionalTests/component/collectiveitf/multicast/ClientTestItf.class"/>
						<exclude name="functionalTests/component/collectiveitf/multicast/MulticastTestItf.class"/>
						<exclude name="functionalTests/component/collectiveitf/multicast/ServerItfTestItf.class"/>
						<exclude name="functionalTests/component/collectiveitf/multicast/ServerParameterAnnotationTester.class"/>
						<exclude name="functionalTests/component/collectiveitf/multicast/ServerTestItf.class"/>
						<exclude name="functionalTests/component/collectiveitf/multicast/ServerItfTestItf.class"/>
						<exclude name="functionalTests/component/collectiveitf/multicast/TestItf.class"/>
						<exclude name="functionalTests/component/collectiveitf/multicast/Tester.class"/>
						<exclude name="functionalTests/component/collectiveitf/multicast/TesterImpl.class"/>
						<exclude name="functionalTests/component/collectiveitf/multicast/classbased/TesterImpl.class"/>
					</fileset>
				</batchtest>
			</junit>
		</sequential>
	</macrodef>


	<target name="junitDistributed" depends="proActiveJar" description="Run all non regression tests">
		<junitMacro nodeDescriptor="/functionalTests/descriptor/defaultnodes/Nodes.xml" />
	</target>

	<target name="junit" depends="proActiveJar" description="Run all non regression tests on the current host only">
		<junitMacro nodedescriptor="/functionalTests/descriptor/defaultnodes/NodesLocal.xml"/>
	</target>

	<target name="junitCoverage" depends="proActiveJar" description="Same as junit but with code coverage enabled">

		<delete dir="${classes.dir}/emma"/>
		<mkdir  dir="${classes.dir}/emma"/>
		<delete dir="${base.dir}/emma"/>
		<mkdir  dir="${base.dir}/emma"/>

		<!-- Instrumentation -->
		<emma enabled="true">
			<instr
				instrpathref="test.classpath"
				destdir="${classes.dir}/emma"
				metadatafile="${base.dir}/emma/metadata.emma"
				merge="true">
				<filter includes="org.objectweb.proactive.*" excludes="pa.*, *_Stub" />
			</instr>	
		</emma>

		<junitMacro nodedescriptor="/functionalTests/descriptor/defaultnodes/NodesLocal.xml">
			<jvmargs>
				<jvmarg value="-Demma.coverage.out.file=${base.dir}/emma/coverage.emma" />
				<jvmarg value="-Demma.coverage.out.merge=true" />
			</jvmargs>
			<additionalClassPath>
				<pathelement location="${classes.dir}/emma"/>
				<path refid="emma.lib"/>
			</additionalClassPath>
		</junitMacro>

		<!-- Reporting -->
		<emma enabled="true" >
			<report 
				sort="+block,+name,+method,+class,+line"
				metrics="method:60,line:50,class:80"
				units="instr">
				<sourcepath>
					<dirset dir="${src.dir}">
						<include name="*"/>
					</dirset>
				</sourcepath>
				<infileset dir="${base.dir}/emma" includes="*.emma, *.ec, *.em" />
				<xml 
					columns="name, class, method, block, line"
					outfile="${base.dir}/emma/coverage.xml"
					depth="source" 
					encoding="UTF-8"/>
				<html 
					columns="name, class, method, block, line"
					outfile="${base.dir}/emma/coverage.html"
					depth="source" />
      			</report>
		</emma>
	</target>	

	<!--	
	<target name="runTestsLocalHttp" depends="nonregressiontest, proActiveJar" description="Run all non regression tests on the current host only">
			<junitMacro nodedescriptor="/nonregressiontest/descriptor/defaultnodes/NodesLocal.xml">
			<jvmargs>
				<jvmarg value="-Dproactive.communication.protocol=http" />
				<jvmarg value="-Dproactive.http.port=2026" />
				<jvmarg value="-Dproactive.locationserver.rmi=http://locahost:2026/LocationServer" />
			</jvmargs>
			</runTestsMacro>
	</target>
-->

	<target name="junitIbis" depends="proActiveJar">
		<junitMacro nodedescriptor="/functionalTests/descriptor/defaultnodes/NodesLocalIbis.xml">
			<jvmargs>
				<jvmarg value="-Dproactive.rmi=ibis" />
				<jvmarg value="-Dibis.serialization=sun" />
				<jvmarg value="-Dibis.name_server.host=localhost" />
				<jvmarg value="-Dibis.name_server.pool=rutget" />
				<jvmarg value="-Dibis.pool.host_number=1" />
				<jvmarg value="-Dibis.name_server.key=12" />
				<jvmarg value="-Dibis.property.file=/home1/fabrice/workIbis/Ibis/properties" />
			</jvmargs>
		</junitMacro>
	</target>


	<!-- ================================================================ -->
	<!--                      Compile TryWithCatch annotator              -->
	<!--  =============================================================== -->

	<target name="trywithcatch" depends="-init">
		<javac srcdir="${src.utils.dir}" destdir="${cl.utils.dir}" includes="trywithcatch/**" deprecation="on" source="${source}" debug="${debug}" />
	</target>


	<!-- ================================================================ -->
	<!--                      Compile util                                -->
	<!--  =============================================================== -->

	<target name="util" depends="-init, core">
		<!-- XXX Timer is in core.util.Profiling -->
		<javac srcdir="${src.utils.dir}" destdir="${cl.utils.dir}" includes="**" deprecation="on" source="${source}" debug="${debug}" >
			<classpath refid="project.classpath" />
		</javac>
	</target>




	<!-- ================================================================ -->
	<!--                      Create ProActive.jar                        -->
	<!--  =============================================================== -->
	<target name="proActiveJar" depends="dist-mk-dir, compile" description="Create the ProActive jar, to be used for instance on a distant host">
		<jar manifest="${manifest.dir}/Manifest.mf"  jarfile="${PAdist.dir}/ProActive.jar">
			<fileset dir="${cl.proactive.dir}" includes="**"/>
			<fileset dir="${cl.extensions.dir}" includes="**"/>
			<fileset dir="${cl.extra.dir}" includes="**"/>

			<fileset dir="${osgi.res.dir}" >
				<include name="metadata.xml" />
			</fileset>
		</jar>
	</target>


	<!-- ================================================================ -->
	<!--           Generate ProActive stubs for all classes               -->
	<!-- ================================================================ -->

	<target name="stubGenerator" depends="-init">
		<javac srcdir="${src.dir}" destdir="${classes.dir}" deprecation="on" source="${source}" debug="${debug}">
			<classpath refid="project.classpath" />
			<include name="${proactive.path}/ext/util/StubGenerator.java" />
		</javac>
	</target>


	<target name="stub" depends="stubGenerator, core">
		<property name="stub.classdir" value="${cl.proactive.dir}" />

		<java classname="org.objectweb.proactive.ext.util.StubGenerator" fork="true">
			<classpath refid="project.classpath" />
			<arg line="-srcDir ${cl.proactive.dir} -pkg org.objectweb.proactive" />
		</java>
	</target>


	<!-- ================================================================ -->
	<!--                  Create  distribution bin                        -->
	<!--  =============================================================== -->

	<target name="dist-mk-dir" description="Make distribution directories">
		<delete dir="${dist.dir}" />
		<mkdir dir="${dist.dir}" />
		<mkdir dir="${PAdist.dir}" />
	</target>


	<target name="dist-cp-files" depends="dist-mk-dir" 
		description="Copy files for the release">
		<!--        copy docs / scripts / src / compile / lib      -->
		<copy todir="${PAdist.dir}" includeEmptyDirs="no">
			<fileset dir="${base.dir}">
				<include name="README.html" />
				<include name="docs/**" />
				<include name="doc-src/**" />
				<include name="scripts/**" />
				<include name="src/org/**" />
				<include name="compile/**" />
				<include name="lib/**" />
				<include name="descriptors/**" />
				<include name="p2p/**" />
				<include name="ic2d-plugins-src/**" />
				<exclude name="p2p/config/**" />
				<exclude name="**/.svn" />
				<exclude name="scripts/unix/grid5000/**" />
				<exclude name="scripts/unix/gridexperiment/**" />
			</fileset>
		</copy>
		<!-- set right files permissions -->
		<chmod dir="${PAdist.dir}/scripts/unix" perm="755" includes="**/*.sh" />
		<chmod file="${PAdist.dir}/compile/build" perm="755" />
	</target>


	<target name="dist-examples-jar" 
		depends="dist-mk-dir, compile">
		<!-- Build the examples Jar -->
		<jar jarfile="${PAdist.dir}/ProActive_examples.jar" 
			basedir="${cl.examples.dir}" 
			includes="**" />
	</target>


	<target name="dist-bin"
		depends="dist-examples-jar, proActiveJar, dist-cp-files"
		description="Create zip with only jars">
		<!-- Zip with Jars: PA, PAExamples, required libs, scripts -->
		<zip zipfile="${dist.dir}/ProActive-bin_${version_}.zip">
			<zipfileset dir="${PAdist.dir}" filemode="755" prefix="ProActive">
				<exclude name="src/**" />
				<exclude name="compile/**" />
				<exclude name="doc-src/**" />
				<exclude name="p2p/**" />
				<exclude name="docs/**" />
				<exclude name="README.html" />
				<exclude name="ic2d-plugins-src/**" />
			</zipfileset>
		</zip>
	</target>


	<target name="dist-doc" depends="docs, dist-cp-files"
		description="Create zip with only doc">
		<zip zipfile="${dist.dir}/ProActive-doc_${version_}.zip">
			<zipfileset dir="${PAdist.dir}/docs" prefix="ProActive/docs" />
		</zip>
	</target>


	<target name="dist-src" depends="dist-cp-files"
		description="Create zip with only sources and libs">
		<zip zipfile="${dist.dir}/ProActive-src_${version_}.zip">
			<zipfileset dir="${PAdist.dir}" filemode="755" prefix="ProActive" >
				<exclude name="docs/**"/>
				<exclude name="ProActive_examples.jar" />
				<exclude name="ProActive.jar" />
			</zipfileset>
		</zip>
	</target>


	<target name="dist-bundle" depends="dist-cp-files, proActiveJar, dist-examples-jar"
		description="Create a zip with everythings">
		<zip zipfile="${dist.dir}/ProActive-bundle_${version_}.zip">
			<zipfileset dir="${PAdist.dir}" filemode="755" prefix="ProActive">
				<exclude name="doc-src/**" />
			</zipfileset>
		</zip>
	</target>


	<target name="dist" depends="dist-doc, dist-bin, dist-src, dist-bundle" 
		description="Create zips for release"/>


	<!-- ================================================================ -->
	<!--        Same as below + format source files                       -->
	<!--  =============================================================== -->

	<target name="copyright_format" depends="update_copyright_and_version, format" />


	<!-- ================================================================ -->
	<!--        Update Copyright and Version in every text files          -->
	<!--  =============================================================== -->

	<target name="update_copyright_and_version" depends="util">
		<java classname="sources.UpdateCopyrightAndVersion" fork="true">
			<classpath refid="project.classpath" />
			<!--  base dir -->
			<arg value="${base.dir}" />
			<!--  exclude dirs -->
			<arg value="${docs.dir}" />
			<arg value="${dist.dir}" />
			<arg value="${classes.dir}" />
			<arg value="${test.classes.dir}" />
			<arg value="${lib.dir}" />
			<arg value="${dev.dir}" />
		</java>
	</target>


	<!-- ================================================================ -->
	<!--            Formats the project sources                           -->
	<!-- ================================================================ -->

	<macrodef name="format_m">
		<attribute name="srcDir" />
		<attribute name="loglevel" default="WARN"/>
		<sequential>
			<!-- declare the Jalopy task -->
			<taskdef name="jalopy" classname="de.hunsicker.jalopy.plugin.ant.AntPlugin">
				<classpath>
					<fileset dir="${base.dir}/dev/lib">
						<include name="*.jar" />
					</fileset>
					<fileset dir="${lib.dir}">
						<include name="log4j.jar" />
					</fileset>
				</classpath>
			</taskdef>

			<jalopy classpathref="project.classpath" convention="${basedir}/proactiveJalopy.xml">
				<fileset dir="@{srcDir}">
					<include name="**/*.java" />
				</fileset>
			</jalopy>
		</sequential>
	</macrodef>

	<target name="format" description="Formats the project source files">
		<parallel threadsperprocessor="1">
			<format_m srcdir="${src.proactive.dir}"/>
			<format_m srcdir="${src.extensions.dir}"/>
			<format_m srcdir="${src.extra.dir}"/>
			<format_m srcdir="${src.examples.dir}"/>
			<format_m srcdir="${src.test.dir}"/>
		</parallel>
	</target>


	<!-- ================================================================ -->
	<!--               Ibisc to generate stubs/skels                      -->
	<!-- ================================================================ -->
	<target name="ibis" description="Everything related to ProActive IBIS">
		<delete>
			<fileset dir="${classes.dir}" includes="**/rmi*.java" />
		</delete>
		<java classname="ibis.frontend.rmi.Rmic"
			  fork="true"
			  dir="${cl.proactive.dir}/org/objectweb/proactive/core/body/ibis/">
			<classpath refid="project.classpath" />
			<arg value="org.objectweb.proactive.core.body.ibis.IbisRemoteBodyImpl" />
		</java>
		<java classname="ibis.frontend.rmi.Rmic"
			  fork="true"
			  dir="${cl.proactive.dir}/org/objectweb/proactive/core/runtime/ibis/">
			<classpath refid="project.classpath" />
			<arg value="org.objectweb.proactive.core.runtime.ibis.IbisProActiveRuntimeImpl" />
		</java>
		<java classname="ibis.frontend.rmi.Rmic"
			  fork="true"
			  dir="${cl.proactive.dir}/org/objectweb/proactive/core/remoteobject/ibis/">
			<classpath refid="project.classpath" />
			<arg value="org.objectweb.proactive.core.remoteobject.ibis.IbisRemoteObjectImpl" />
		</java>
		<javac srcdir="${cl.proactive.dir}" destdir="${cl.proactive.dir}"
			   deprecation="on" source="${source}" debug="${debug}">
			<include name="**/*.java" />
			<classpath refid="project.classpath" />
		</javac>
	</target>



	<target name="jdepend"  depends="compile" description="JDepend report">
		<macrodef name="jdependMacro">
			<attribute name="outputfile" />
			<attribute name="classesdir" />
			<sequential>
				<jdepend format="xml" outputfile="${base.dir}/@{outputfile}.xml">
					<classespath>
						<pathelement location="@{classesdir}" />
					</classespath>
				</jdepend>
				<xslt includes="@{outputfile}.xml" basedir="${base.dir}" destdir="${base.dir}" style="jdepend.xsl" />
				<delete>
					<fileset dir="${base.dir}">
						<include name="@{outputfile}.xml"/>
					</fileset>
				</delete>
				<echo> --> JDepend report available: ${base.dir}/@{outputfile}.html</echo>
			</sequential>
		</macrodef>

		<jdependMacro outputfile="jdepend_core" classesdir="${cl.proactive.dir}" />
		<jdependMacro outputfile="jdepend_all"  classesdir="${classes.dir}"/>
	</target>


	<!-- ==================================================================== -->
	<!-- Compile native MicroTimer                                                    -->
	<!-- ==================================================================== -->
	<target name="microTimer">
		<exec dir="${src.dir}/org/objectweb/proactive/core/util/timer" executable="g++" os="Linux">
			<arg line=" -shared -o libMicroTimer.so  MicroTimer.cc" />
		</exec>
		<copy file="${src.dir}/org/objectweb/proactive/core/util/timer/libMicroTimer.so" todir="${lib.dir}" />
	</target>

	<!-- ================================================================ -->
	<!--                    Create OSGi LibraryBundle.jar                 -->
	<!--  =============================================================== -->
	<target name="librariesBundle">
		<mkdir dir="${bundle.dir}" />
		<jar manifest="${manifest.dir}/ManifestLibraries.mf" jarfile="${bundle.dir}/librariesBundle.jar">
			<fileset dir="${lib.dir}/">
				<include name="javassist.jar" />
				<include name="log4j.jar" />
				<include name="xercesImpl.jar" />
				<include name="bouncycastle.jar" />
				<include name="components/fractal.jar" />
			</fileset>
		</jar>
	</target>

	<!-- ================================================================ -->
	<!--                          IC2D Libraries                          -->
	<!--  =============================================================== -->

	<target name="ic2dLib" depends="proActiveJar" description="Copy all needed libraries to IC2D">
		<property name="ic2d-plugin.dir" value="${base.dir}/ic2d-plugins-src" />
		<property name="plugin.lib" value="org.objectweb.proactive.ic2d.lib" />
		<copy todir="${ic2d-plugin.dir}/${plugin.lib}/lib" includeemptydirs="no">
			<fileset dir="${lib.dir}" />
		</copy>
		<copy file="${PAdist.dir}/ProActive.jar" todir="${ic2d-plugin.dir}/${plugin.lib}" />
	</target>

	<!-- ================================================================ -->
	<!--                          Performance test                        -->
	<!-- ================================================================ -->

	<target name="runPerformanceTest" depends="" description="Run performance test on the current host.">
		<property name="n" value="" />
		<property name="o" value="" />
		<property name="p" value="" />
		<property name="c" value="" />
		<property name="x" value="" />
		<echo message="Starting the performance test." />
		<java classname="${performanceTestClass}" fork="true">
			<classpath refid="project.classpath" />
			<jvmarg value="-Djava.security.policy=${base.dir}/compile/proactive.java.policy" />
			<jvmarg value="-Dlog4j.configuration=file:${base.dir}/compile/proactive-log4j" />
			<arg value="-n" />
			<arg value="${n}" />
			<arg value="-o" />
			<arg value="${o}" />
			<arg value="-p" />
			<arg value="${p}" />
			<arg value="-c" />
			<arg value="${c}" />
			<arg value="-x" />
			<arg value="${x}" />
		</java>
	</target>

</project>
